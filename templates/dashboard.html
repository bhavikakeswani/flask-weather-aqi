{% extends 'base.html' %}

{% block title %}Dashboard | SkySQI{% endblock %}

{% block content %}

    <main class="dashboard">
        <section class="forecast-toggle">
            <div class="tabs">
                <button id="today-btn" class="active">Today</button>
                <button id="tomorrow-btn">Tomorrow</button>
                <button id="weekly-btn">Next 5 days</button>
            </div>
            <div class="switch-wrapper">
                <label class="forecast-switch">
                    <input type="checkbox" id="toggle-forecast">
                    <span class="forecast-slider">
                        <span class="on">Forecast</span>
                        <span class="off">Air Quality</span>
                    </span>
                </label>
            </div>
        </section>

        <section class="current-weather">
            <div class="weather-wrapper">
                <div class="temp-card">
                    {% if weather %}
                        <h2>{{ weather['main']['temp'] }}° {{ 'C' if current_user.temp_unit == 'Celsius' else 'F' }}</h2>
                        <p>Real Feel {{ weather['main']['feels_like'] }}°</p>
                        <p>Wind: {{ weather['wind']['speed'] }} {{ 'm/s' if current_user.temp_unit == 'Celsius' else 'mph' }}</p>
                        <p>Pressure: {{ weather['main']['pressure'] }} hPa</p>
                        <p>Humidity: {{ weather['main']['humidity'] }}%</p>
                        <p>Sunrise: {{ weather['sys']['sunrise'] | datetimeformat }} | Sunset: {{ weather['sys']['sunset'] | datetimeformat }}</p>
                    {% else %}
                        <p>No weather data available.</p>
                    {% endif %}
                </div>

                <div class="forecast">
                    {% for day in weekly_forecast %}
                        <div class="day">{{ day.date }} <br>
                            <img src="http://openweathermap.org/img/wn/{{ day.icon }}@2x.png" alt="weather icon" width="60">
                            <br>
                            <span>{{ day.temp }}°</span></div>
                    {% endfor %}
                </div>
                <div class="rain-chart">
                    <h3>Chance of Rain</h3>
                    <canvas id="rainChart"></canvas>
                </div>
            </div>
        </section>

        <section class="overview">
            <div class="card">
                Wind Status <br> {{ weather['wind']['speed'] }} {{ 'm/s' if current_user.temp_unit == 'Celsius' else 'mph' }}
            </div>
            <div class="card">
                UV Index <br>
                {% if uv_index is not none %}
                    {{ uv_index }}
                {% else %}
                    Not available
                {% endif %}
            </div>
            <div class="card">
                Humidity <br> {{ weather['main']['humidity'] }}%
            </div>
            <div class="card">
                Visibility <br> {{ (weather['visibility'] / 1000) | round(1) }} km
            </div>
        </section>

        <section class="explore">
            <img src="{{ city_image or url_for('static', filename='images/fallback.jpg') }}" alt="City view">
        </section>

        <section class="other-cities">
            {% for c in other_cities_weather %}
                <div class="city">
                {{ c.name }} – {{ c.description }} ({{ c.temp }}°C)
                </div>
            {% endfor %}
        </section>
    </main>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const forecastDiv = document.querySelector(".forecast");
    const todayBtn = document.getElementById("today-btn");
    const tomorrowBtn = document.getElementById("tomorrow-btn");
    const weeklyBtn = document.getElementById("weekly-btn");

    const weeklyForecast = JSON.parse(`{{ weekly_forecast | tojson | safe }}`);
    const tomorrowForecast = JSON.parse(`{{ tomorrow_forecast | tojson | safe }}`);
    const nextDaysForecast = JSON.parse(`{{ next_days_forecast | tojson | safe }}`);

    const ctx = document.getElementById('rainChart').getContext('2d');
    let rainChart;

    function renderForecast(forecast) {
        forecastDiv.innerHTML = "";
        if (!forecast) {
            forecastDiv.innerHTML = "<p>No forecast available</p>";
            updateRainChart([], []);
            return;
        }
        if (!Array.isArray(forecast)) forecast = [forecast];

        const labels = [];
        const rainData = [];

        forecast.forEach(day => {
            const div = document.createElement("div");
            div.classList.add("day");
            div.innerHTML = `
                ${day.date} <br>
                <img src="http://openweathermap.org/img/wn/${day.icon}@2x.png" width="60" alt="weather icon"><br>
                <span>${day.temp}°</span>
            `;
            forecastDiv.appendChild(div);
            labels.push(day.date);
            rainData.push(day.pop || 0);
        });

        updateRainChart(labels, rainData);
    }

    function updateRainChart(labels, data) {
        if (rainChart) rainChart.destroy();
        rainChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Chance of Rain (%)',
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: { y: { beginAtZero: true, max: 100 } },
                plugins: { legend: { display: false } }
            }
        });
    }

    todayBtn.addEventListener("click", function() {
        renderForecast([weeklyForecast[0]]);
        todayBtn.classList.add("active");
        tomorrowBtn.classList.remove("active");
        weeklyBtn.classList.remove("active");
    });

    tomorrowBtn.addEventListener("click", function() {
        renderForecast(tomorrowForecast);
        todayBtn.classList.remove("active");
        tomorrowBtn.classList.add("active");
        weeklyBtn.classList.remove("active");
    });

    weeklyBtn.addEventListener("click", function() {
        renderForecast(nextDaysForecast);
        todayBtn.classList.remove("active");
        tomorrowBtn.classList.remove("active");
        weeklyBtn.classList.add("active");
    });

    renderForecast([weeklyForecast[0]]);
});
</script>
{% endblock %}