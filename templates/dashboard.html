{% extends 'base.html' %}

{% block title %}{{ _('Dashboard') }} | SkySQI{% endblock %}

{% block content %}
<main class="dashboard">
    <section class="forecast-toggle">
        <div class="tabs">
            <button id="today-btn" class="active">{{ _('Today') }}</button>
            <button id="tomorrow-btn">{{ _('Tomorrow') }}</button>
            <button id="weekly-btn">{{ _('Next 5 days') }}</button>
        </div>
        <div class="switch-wrapper">
            <label class="forecast-switch">
                <input type="checkbox" id="toggle-forecast">
                <span class="forecast-slider">
                    <span class="on">{{ _('Forecast') }}</span>
                    <span class="off">{{ _('Air Quality') }}</span>
                </span>
            </label>
        </div>
    </section>

    <section class="current-weather">
        <div class="weather-wrapper">
            <div class="temp-card">
                {% if weather %}
                    <h2>{{ weather['main']['temp'] }} {{ unit_symbol }}</h2>
                    <p>{{ _('Real Feel') }} {{ weather['main']['feels_like'] }} {{ unit_symbol }}</p>
                    <p>{{ _('Wind') }}: {{ weather['wind']['speed'] }} {{ wind_unit }}</p>
                    <p>{{ _('Pressure') }}: {{ weather['main']['pressure'] }} hPa</p>
                    <p>{{ _('Humidity') }}: {{ weather['main']['humidity'] }}%</p>
                    <p>{{ _('Sunrise') }}: {{ weather['sys']['sunrise'] | datetimeformat }} | {{ _('Sunset') }}: {{ weather['sys']['sunset'] | datetimeformat }}</p>
                {% else %}
                    <p>{{ _('No weather data available.') }}</p>
                {% endif %}
            </div>

            <div class="forecast">
                {% for day in weekly_forecast %}
                    <div class="day">{{ day.date }} <br>
                        <img src="http://openweathermap.org/img/wn/{{ day.icon }}@2x.png" alt="weather icon" width="60">
                        <br>
                        <span>{{ day.temp }} {{ unit_symbol }}</span>
                    </div>
                {% endfor %}
            </div>
            <div class="rain-chart">
                <h3>{{ _('Chance of Rain') }}</h3>
                <canvas id="rainChart"></canvas>
            </div>
        </div>
    </section>

    <section class="overview">
        <div class="card">{{ _('Wind Status') }} <br> {{ weather['wind']['speed'] }} {{ wind_unit }}</div>
        <div class="card">{{ _('UV Index') }} <br>
            {% if uv_index is not none %}
                {{ uv_index }}
            {% else %}
                {{ _('Not available') }}
            {% endif %}
        </div>
        <div class="card">{{ _('Humidity') }} <br> {{ weather['main']['humidity'] }}%</div>
        <div class="card">{{ _('Visibility') }} <br> {{ (weather['visibility'] / 1000) | round(1) }} km</div>
    </section>

    <section class="explore">
        <img src="{{ city_image or url_for('static', filename='images/fallback.jpg') }}" alt="{{ _('City view') }}">
    </section>

    <section class="other-cities">
        {% for c in other_cities_weather %}
            <div class="city">
            {{ c.name }} â€“ {{ c.description }} ({{ c.temp }} {{ unit_symbol }})
            </div>
        {% endfor %}
    </section>
</main>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const forecastDiv = document.querySelector(".forecast");
    const todayBtn = document.getElementById("today-btn");
    const tomorrowBtn = document.getElementById("tomorrow-btn");
    const weeklyBtn = document.getElementById("weekly-btn");

    const weeklyForecast = JSON.parse(`{{ weekly_forecast | tojson | safe }}`);
    const tomorrowForecast = JSON.parse(`{{ tomorrow_forecast | tojson | safe }}`);
    const nextDaysForecast = JSON.parse(`{{ next_days_forecast | tojson | safe }}`);
    const unitSymbol = `{{ unit_symbol }}`;

    const ctx = document.getElementById('rainChart').getContext('2d');
    let rainChart;

    function renderForecast(forecast) {
        forecastDiv.innerHTML = "";
        if (!forecast) {
            forecastDiv.innerHTML = "<p>No forecast available</p>";
            updateRainChart([], []);
            return;
        }
        if (!Array.isArray(forecast)) forecast = [forecast];

        const labels = [];
        const rainData = [];

        forecast.forEach(day => {
            const div = document.createElement("div");
            div.classList.add("day");
            div.innerHTML = `
                ${day.date} <br>
                <img src="http://openweathermap.org/img/wn/${day.icon}@2x.png" width="60" alt="weather icon"><br>
                <span>${day.temp} ${unitSymbol}</span>
            `;
            forecastDiv.appendChild(div);
            labels.push(day.date);
            rainData.push(day.pop || 0);
        });

        updateRainChart(labels, rainData);
    }

    function updateRainChart(labels, data) {
        if (rainChart) rainChart.destroy();
        rainChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Chance of Rain (%)',
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: { y: { beginAtZero: true, max: 100 } },
                plugins: { legend: { display: false } }
            }
        });
    }

    todayBtn.addEventListener("click", function() {
        renderForecast([weeklyForecast[0]]);
        todayBtn.classList.add("active");
        tomorrowBtn.classList.remove("active");
        weeklyBtn.classList.remove("active");
    });

    tomorrowBtn.addEventListener("click", function() {
        renderForecast(tomorrowForecast);
        todayBtn.classList.remove("active");
        tomorrowBtn.classList.add("active");
        weeklyBtn.classList.remove("active");
    });

    weeklyBtn.addEventListener("click", function() {
        renderForecast(nextDaysForecast);
        todayBtn.classList.remove("active");
        tomorrowBtn.classList.remove("active");
        weeklyBtn.classList.add("active");
    });

    renderForecast([weeklyForecast[0]]);
});
</script>
{% endblock %}